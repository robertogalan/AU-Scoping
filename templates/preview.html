{% extends "base.html" %}

{% block title %}Column Identification - Account Mapping Tool{% endblock %}

{% block extra_css %}
<style>
    .preview-container {
        max-width: 90%;
        margin: 0 auto;
        padding: 20px;
    }
    .header {
        text-align: center;
        margin-bottom: 30px;
    }
    .preview-table {
        font-size: 14px;
        margin-bottom: 30px;
    }
    .table-container {
        overflow-x: auto;
    }
    .mapping-form {
        background-color: #fff;
        padding: 20px;
        border-radius: 5px;
        margin-bottom: 30px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    }
    .form-group {
        margin-bottom: 15px;
    }
    .form-label {
        font-weight: 400;
    }
    .card-header h5 {
        font-weight: 300;
    }
</style>
{% endblock %}

{% block content %}
    <div class="container preview-container">
        <div class="header">
            <h1 class="font-ultralight">Confirm Column Identification</h1>
            <p class="text-muted font-ultralight">Please confirm or adjust the column types.</p>
        </div>

        {% with messages = get_flashed_messages() %}
        {% if messages %}
        <div class="alert alert-warning">
            <ul class="mb-0">
                {% for message in messages %}
                <li>{{ message }}</li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}
        {% endwith %}

        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0 font-ultralight">Data Preview</h5>
            </div>
            <div class="card-body table-container">
                <table class="table table-striped table-bordered preview-table">
                    <thead>
                        <tr>
                            {% for column in columns %}
                            <th>{{ column }}</th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in preview_data %}
                        <tr>
                            {% for column in columns %}
                            <td>{{ row[column] }}</td>
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h5 class="mb-0 font-ultralight">Column Mapping</h5>
            </div>
            <div class="card-body">
                <form action="{{ url_for('process_mapping') }}" method="post" class="mapping-form">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="account_name_col" class="form-label">Account Name Column:</label>
                                <select name="account_name_col" id="account_name_col" class="form-select" required>
                                    <option value="">Select column</option>
                                    {% for column in columns %}
                                    <option value="{{ column }}" {% if column_mapping and column_mapping.get('account_name_col') == column %}selected{% endif %}>{{ column }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="account_number_col" class="form-label">Account Number Column (if available):</label>
                                <select name="account_number_col" id="account_number_col" class="form-select">
                                    <option value="">None</option>
                                    {% for column in columns %}
                                    <option value="{{ column }}" {% if column_mapping and column_mapping.get('account_number_col') == column %}selected{% endif %}>{{ column }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="form-group mt-3">
                        <label class="form-label">Balance Column Type:</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="balance_type" id="balance_type_combined" value="combined" 
                                {% if not column_mapping or column_mapping.get('balance_type') == 'combined' %}checked{% endif %} 
                                onchange="toggleBalanceFields()">
                            <label class="form-check-label" for="balance_type_combined">
                                Combined Balance Column (single column)
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="balance_type" id="balance_type_separate" value="separate" 
                                {% if column_mapping and column_mapping.get('balance_type') == 'separate' %}checked{% endif %} 
                                onchange="toggleBalanceFields()">
                            <label class="form-check-label" for="balance_type_separate">
                                Separate Debit and Credit Columns
                            </label>
                        </div>
                    </div>

                    <div id="combined_balance_div" class="form-group mt-3" style="display: {% if not column_mapping or column_mapping.get('balance_type') == 'combined' %}block{% else %}none{% endif %};">
                        <label for="balance_col" class="form-label">Balance Column:</label>
                        <select name="balance_col" id="balance_col" class="form-select">
                            <option value="">Select column</option>
                            {% for column in columns %}
                            <option value="{{ column }}" {% if column_mapping and column_mapping.get('balance_type') == 'combined' and column_mapping.get('balance_cols', {}).get('balance') == column %}selected{% endif %}>{{ column }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div id="separate_balance_div" class="row mt-3" style="display: {% if column_mapping and column_mapping.get('balance_type') == 'separate' %}block{% else %}none{% endif %};">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="debit_col" class="form-label">Debit Column:</label>
                                <select name="debit_col" id="debit_col" class="form-select">
                                    <option value="">Select column</option>
                                    {% for column in columns %}
                                    <option value="{{ column }}" {% if column_mapping and column_mapping.get('balance_type') == 'separate' and column_mapping.get('balance_cols', {}).get('debit') == column %}selected{% endif %}>{{ column }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="credit_col" class="form-label">Credit Column:</label>
                                <select name="credit_col" id="credit_col" class="form-select">
                                    <option value="">Select column</option>
                                    {% for column in columns %}
                                    <option value="{{ column }}" {% if column_mapping and column_mapping.get('balance_type') == 'separate' and column_mapping.get('balance_cols', {}).get('credit') == column %}selected{% endif %}>{{ column }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="mt-4 d-flex justify-content-between">
                        <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">Back</a>
                        <button type="submit" class="btn btn-primary">Process Mapping</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    {% block extra_js %}
    <script>
        function toggleBalanceFields() {
            const combinedType = document.getElementById('balance_type_combined').checked;
            document.getElementById('combined_balance_div').style.display = combinedType ? 'block' : 'none';
            document.getElementById('separate_balance_div').style.display = combinedType ? 'none' : 'block';
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            toggleBalanceFields();
        });
    </script>
    {% endblock %}
{% endblock %}
