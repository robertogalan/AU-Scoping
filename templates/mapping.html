{% extends "base.html" %}

{% block title %}Mapping Results - Account Mapping Tool{% endblock %}

{% block extra_css %}
<style>
    .results-container {
        max-width: 90%;
        margin: 0 auto;
        padding: 20px;
    }
    .header {
        text-align: center;
        margin-bottom: 30px;
    }
    .preview-table {
        font-size: 14px;
        margin-bottom: 30px;
    }
    .table-container {
        overflow-x: auto;
    }
    .stats-card {
        margin-bottom: 20px;
    }
    .category-count {
        font-size: 1.1rem;
        font-weight: 400;
    }
    .stats-card .card-header h5 {
        font-weight: 300;
    }
    .table th {
        font-weight: 400;
    }
</style>
{% endblock %}

{% block content %}
    <div class="container results-container">
        <div class="header">
            <h1 class="font-ultralight">Mapping Complete</h1>
            <p class="text-muted font-ultralight">Your accounts have been mapped to global and specific categories</p>
        </div>

        {% with messages = get_flashed_messages() %}
        {% if messages %}
        <div class="alert alert-warning">
            <ul class="mb-0">
                {% for message in messages %}
                <li>{{ message }}</li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}
        {% endwith %}

        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card stats-card">
                    <div class="card-header">
                        <h5 class="mb-0 font-ultralight">Global Mapping</h5>
                    </div>
                    <div class="card-body">
                        <ul class="list-group">
                            {% for category, count in mapping_summary.global_counts.items() %}
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                {{ category }}
                                <span class="badge bg-primary rounded-pill">{{ count }}</span>
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card stats-card">
                    <div class="card-header">
                        <h5 class="mb-0 font-ultralight">Specific Mapping</h5>
                    </div>
                    <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                        <ul class="list-group">
                            {% for category, count in mapping_summary.specific_counts.items() %}
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                {{ category }}
                                <span class="badge bg-secondary rounded-pill">{{ count }}</span>
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0 font-ultralight">Mapping Preview</h5>
                <span class="text-muted">Showing first 20 rows of {{ mapping_summary.total_accounts }} accounts</span>
            </div>
            <div class="card-body table-container">
                <table class="table table-striped table-bordered preview-table">
                    <thead>
                        <tr>
                            {% for key in preview_data[0].keys() %}
                            <th>{{ key }}</th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in preview_data %}
                        <tr>
                            {% for key, value in row.items() %}
                            <td>{{ value }}</td>
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h5 class="mb-0 font-ultralight">Download Results</h5>
            </div>
            <div class="card-body">
                <p>Your mapped file is ready for download. The file includes all your original data plus the following new columns:</p>
                <ul>
                    <li><strong>Global_Mapping</strong>: High-level category (Asset, Liability, Equity, Income, Expense)</li>
                    <li><strong>Specific_Mapping</strong>: Detailed classification within the global category</li>
                </ul>
                <div class="mt-3">
                    <a href="{{ url_for('download_mapped_file') }}" class="btn btn-success">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-download me-2" viewBox="0 0 16 16">
                            <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                            <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
                        </svg>
                        Download Mapped Excel File ({{ output_filename }})
                    </a>
                </div>
            </div>
        </div>

        <div class="mt-4 d-flex justify-content-between">
            <a href="{{ url_for('index') }}" class="btn btn-outline-primary">Start New Mapping</a>
            <a href="{{ url_for('set_materiality') }}" class="btn btn-primary">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-right-circle me-2" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M1 8a7 7 0 1 0 14 0A7 7 0 0 0 1 8zm15 0A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM4.5 7.5a.5.5 0 0 0 0 1h5.793l-2.147 2.146a.5.5 0 0 0 .708.708l3-3a.5.5 0 0 0 0-.708l-3-3a.5.5 0 1 0-.708.708L10.293 7.5H4.5z"/>
                </svg>
                Continue to Materiality & Scoping
            </a>
        </div>
    </div>
{% endblock %}
