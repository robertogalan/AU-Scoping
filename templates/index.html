{% extends "base.html" %}

{% block content %}
    <div class="container upload-container mt-4">
        <div class="header">
            <h1 class="font-ultralight">Audit Mapping Tool</h1>
            <p class="text-muted font-ultralight">Upload your Chart of Accounts or Trial Balance Excel file to begin the mapping process</p>
        </div>

        {% with messages = get_flashed_messages() %}
        {% if messages %}
        <div class="alert alert-warning">
            <ul class="mb-0">
                {% for message in messages %}
                <li>{{ message }}</li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}
        {% endwith %}

        <form action="{{ url_for('upload_file') }}" method="post" enctype="multipart/form-data">
            <div class="upload-box">
                <div id="upload-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="#6c757d" class="bi bi-file-earmark-excel" viewBox="0 0 16 16">
                        <path d="M5.884 6.68a.5.5 0 1 0-.768.64L7.349 10l-2.233 2.68a.5.5 0 0 0 .768.64L8 10.781l2.116 2.54a.5.5 0 0 0 .768-.641L8.651 10l2.233-2.68a.5.5 0 0 0-.768-.64L8 9.219l-2.116-2.54z"/>
                        <path d="M14 14V4.5L9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2zM9.5 3A1.5 1.5 0 0 0 11 4.5h2V14a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h5.5v2z"/>
                    </svg>
                </div>
                <p class="mt-3">Drag and drop your Excel file here</p>
                <p class="text-muted">or</p>
                <!-- <label for="file-input" class="browse-btn">Browse Files</label> -->
                <input type="file" id="file-input" name="file" accept=".xlsx,.xls,.csv">
                <div class="file-info" id="file-info"></div>
            </div>
            <button type="submit" class="btn btn-primary w-100">Upload and Continue</button>
        </form>

        <div class="mt-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0 font-ultralight">About This Tool</h5>
                </div>
                <div class="card-body">
                    <p>This tool automates trial balance processing and audit universe scoping through AI-powered account classification and materiality calculations:</p>
                    <ol>
                        <li>Upload your trial balance Excel file</li>
                        <li>AI identifies account name, number, and balance columns automatically</li>
                        <li>OpenAI GPT-4 classifies accounts into financial statement categories (Asset, Liability, Equity, Revenue, Expense)</li>
                        <li>Accounts are mapped to specific audit areas (Cash, Receivables, PPE, etc.) using fuzzy matching algorithms</li>
                        <li>Set materiality benchmarks and percentages for audit planning</li>
                        <li>Calculate overall materiality, performance materiality, and clearly trivial thresholds</li>
                        <li>Generate scoped account listing based on materiality thresholds for audit procedures</li>
                        <li>Export processed files with complete mapping and scoping classifications</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>
    
    {% block extra_js %}
    <script>
        // Handle file selection and drag & drop
        document.addEventListener('DOMContentLoaded', function() {
            const fileInput = document.getElementById('file-input');
            const fileInfo = document.getElementById('file-info');
            const uploadBox = document.querySelector('.upload-box');

            if (fileInput) {
                fileInput.addEventListener('change', () => {
                    if (fileInput.files.length > 0) {
                        fileInfo.textContent = `Selected file: ${fileInput.files[0].name}`;
                        fileInfo.classList.add('text-success');
                    }
                });
            }

            if (uploadBox) {
                uploadBox.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadBox.style.borderColor = '#0d6efd';
                    uploadBox.style.backgroundColor = '#e9f0ff';
                });

                uploadBox.addEventListener('dragleave', () => {
                    uploadBox.style.borderColor = '#ccc';
                    uploadBox.style.backgroundColor = '#fff';
                });

                uploadBox.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadBox.style.borderColor = '#0d6efd';
                    uploadBox.style.backgroundColor = '#e9f0ff';

                    if (e.dataTransfer.files.length > 0) {
                        fileInput.files = e.dataTransfer.files;
                        fileInfo.textContent = `Selected file: ${e.dataTransfer.files[0].name}`;
                        fileInfo.classList.add('text-success');
                    }
                });
            }
        });
    </script>
    {% endblock %}
{% endblock %}
